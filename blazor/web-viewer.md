# Web Viewer 개발

## 2019년

ERP가 웹으로 전환함에 있어서 ReportViewer또한 웹으로 표시해야 할 필요성이 생겼습니다. \
(물론 꽤 오래전부터 이슈가 되었지만, 기술의 한계로 인하여 중단되었습니다.)

기존 윈도우 클라이언트 버전에서 Web으로 전환하는데 여러 프레임워크를 테스트 했었습니다. \
HTML5 Canvas, TypeScript, Unity, Blazor

1. HTML5 Canvas의 경우 가장 기본이 되는 표준 프레임워크라서 제일먼저 시도했지만 Canvas Drawing 의 경우 폰트에 따라서 글자에 깍두기 현상이 일어나서 기각되었습니다.\
   (2023.07 테스트 해봤지만 확대시 폰트가 각지는 현상이 그대로 입니다.)
2. 이후 TypeScript 로 구조를 잡고나서 실제 개발을 1\~2달 정도 진행했을때 문제가 발견되었습니다. 기존 프로그램에는 동적으로 C# 코드를 실행을 해서 데이터를 후처리 하는 기능이 있는데 (Jint)\
   TypeScript로는 불가능했습니다. JavaScript 정도만 실행가능하고, 실제 커스텀하게 만든 C#은 실행할 방법이 없었습니다.
3. 그 문제를 해결하기 위해 결국 .Net 환경으로 해결할 수 밖에 없었습니다. (기존 서식의 호환성을 포기할 수가 없었기 때문에..)
4. Unity로도 한달정도 WebGL 프로토타입을 만들어봤지만, 실제 인쇄를 하기 위해서 서버가 필요했기 때문에 이것도 기각되었습니다. (지금 생각하면 결국 서버모드로 개발했는데 기각할 필요가 없을듯)
5. 그러던중 Blazor라는 것을 알게되었고, JInt 테스트를 해본결과 버전이 달라서 약간 지원되는 기능의 차이는 있었지만 허용범위 내여서 이걸로 결정하고 개발을 진행했습니다.

개발 개발  당시전은 .Net Core3.1



***

## 2020년

기존 서식을  불러올경우 90%정도의 호환성을 유지할정도가 되었을때 성능테스트를 진행했습니다.

WASM의 경우 너무 느려서 사용할 수 없었습니다. 실제 렌더링하기 위해 데이터를 가공하는 시간도 느리긴 했지만 가장 큰 문제는 .Net의 오브젝트를 렌더링 하기 위해 데이터를JavaScript로 전달하는  과정(Json전달)이 .Net Core3.1 버전 기준으로 1메가당 1초가 걸렸습니다.

평범한 단순 표 서식의 경우 100kb 이내로 생성되지만 복잡한 법정서식의 경우 1메가이상되기 때문입니다.  물론 1\~2장은 아무 문제가 되지 않지만, ERP 시스템을 대상으로 하기 때문에 수백장을 한번에 출력할 경우를 생각해야 했습니다. 500장 생각하면 데이터 넘기는데만 500초..가 걸립니다.

물론 이건 프레임워크 버전이 업그레이드 됨에 따라서 점점 속도가 빨라졌습니다. \
(당시에 .Net 5가 릴리즈 되어서 마이그레이션을  진행했고, 체감상 20%정도의 성능이 향상되는걸로 느껴졌습니다.)&#x20;



프레임워크에 따라서 성능이 개선된다 하더라도 몇배 이상 빨라지는 것이 아니기 때문에 , 결국 서버 모델로 다시진행 해야  했습니다.

서버의 경우 기존 클라이언트 프로그램과 거의 차이가 없을 정도의 속도로 표현이 가능했습니다. 차이점은 계산이 완료된 다음에 해당 데이터를 클라이언트로 다운받는 시간이 추가된다는 점.

단지 모든 계산이 서버에서 이뤄지기 때문에 수십, 수백명이 동시에 대량의 데이터를 출력할 것을 예상해서 실제 업체에 구축되는 서버와 별개의 서버구축이 필요했습니다.

서버 4대를 로드밸런싱 구성하고, 동시 접속 테스트 결과 몇십 몇  백만이 호출되어도 WebViewer 서버의 경우는 느려지기만 하고 정상동작을 했습니다. 문제는 ERP서버가 너무 많은 API요청을 처리하지 못했습니다.

안정성까지 확보를 했지만, 실제 업체에 서버한대가 더 추가된다는것에 대한 부담감? + URL 프로토콜을 사용하여 윈도우 버전으로 실행가능하기 때문에 실제 구축한 사례는 없습니다.

***

## 2023년

.Net7 릴리즈를 계기로 Client 버전으로 컨버팅을 했습니다.&#x20;

기존 클라이언트의 문제점인 UI 가 끊기는 현상때문에 UI를 JavaScript에서 Blazor 컨트롤로 전부 변경했습니다. \
(동기로 호출되는 JavaScript 문제로 인해서 CPU를 많이 사용하는 작업에서 UI 렉이 발생하는 줄알았지만 그게 아니라 CSS 문제입니다.)

그러면서 다국어 및 테마변경, 그리고 그동안 클라이언트 업데이트 내역  또한 전부 반영시켰습니다.&#x20;

현재 실제 Report 만 JavaScript로 생성합니다.&#x20;

가장 큰 변화는 Ahead-Of-Time 을 적용한 것 입니다.  적용 방법이야 단순 옵션체크로 간단하지만 적용하는 순간 동작하지 않는 모듈들이 나와서 예외처리하는게 힘들었습니다.&#x20;

왜냐하면 컴파일시간이 20분가까히 걸리기 때문에 작은것 하나 수정하는것도 어렵기 때문입니다. + 디버깅의 경우 해당 모드로 동작되지도 않기 때문입니다.



그러나  AOT적용시  WASM이 거의 서버모드 속도로 동작됩니다. 브라우저로 인해서 느렸던 현상이 전부 사라졌습니다.&#x20;

그러나 큰 단점은. 기존 배포 사이즈가 30메가 정도였던것이 100메가 이상 늘어났기 때문에 첫 접속시 다운받는 시간이 오래 걸리게 되었습니다.&#x20;

그래도 WASM의 경우 기존 ERP 메뉴내에 iframe 으로 포함시킬수 있고, 백그라운드로 파일변환도 가능합니다.&#x20;
